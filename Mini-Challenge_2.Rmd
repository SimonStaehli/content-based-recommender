```{r}
#install packages
library("renv")
library("testthat")
renv::restore()

```
copy in separate chunk to install if not yet installed

library("reshape2")
library("recommenderlab")
library("dplyr")
library("tidyr")
library("ggplot2")
library("vegan")
library("coop")
library("bench")
library("gridExtra")


# Content-based Movie Recommender

## Erzeugung von Film- & Nutzerprofilen


1.MovieLense Daten einlesen
```{r}
data("MovieLense")
MovieLense
```
2.Binäre User-Liked-Items Matrix für alle Nutzer erzeugen.
```{r}
MINIMUM_RATING = 1
MovieLense_binary <- recommenderlab::binarize(x = MovieLense, minRating = MINIMUM_RATING)

# Test
check_binary_matrix <- test_that(
  "Check binary matrix", {
    expect_equal(class(as(MovieLense_binary, "matrix")[1]), "logical")
  }
)
```

3.Dimension der User-Liked-Items Matrix prüfen und ausgeben.
```{r}
dim(MovieLense_binary)
```


4.Movie-Genre Matrix für alle Filme erzeugen.
```{r}
as(MovieLense_binary, "data.frame")

movie_genre <- MovieLenseMeta %>%
  dplyr::select(-c(url, year))
```



5.Dimension der Movie-Genre Matrix prüfen und ausgeben.
```{r}
dim(movie_genre)
```


6.Anzahl unterschiedlicher Filmprofile bestimmen und visualisieren.

```{r}
tmp <- movie_genre %>%
  dplyr::select(-title) %>%
  rowSums()

hist(tmp, xlim=c(0,10), 
     col="lightblue", xlab="Number of Genres", 
     ylab="Count", main="Distribution of Ratings per Movie" )
```
**Beschreibung:**

Anhand dieses Plots kann man sehen, dass die Vielzahl der Filme grundsätzlich ein Genre haben. Es gibt jedoch zahlreiche Filme, die mit mehr als einem Genre beschrieben sind. 


```{r}
tmp <- tidyr::pivot_longer(data = movie_genre, cols = 2:dim(movie_genre)[[2]], names_to = "genre")

tmp <- tmp %>%
  dplyr::filter(value > 0) %>%
  dplyr::group_by(genre) %>%
  dplyr::count() %>%
  dplyr::arrange(n)

tmp$genre <- factor(tmp$genre, levels = tmp$genre)

ggplot2::ggplot(tmp, ggplot2::aes(x = n, y = genre, label = n)) +
  ggplot2::geom_segment(ggplot2::aes(x = 0, y = genre, xend = n, yend = genre), color = "grey50") +
  ggplot2::geom_point(size=3, color = "lightblue") +
  ggplot2::geom_text(nudge_x =25) +
  ggplot2::theme_bw() + 
  ggplot2::xlab("Counts")

```
**Beschreibung:**
Der Plot zeigt die Anzahl der Counts pro Genre. Der Plot zeigt, dass das Genre "Drama" und "Comedy" klar die meisten
Filme besitzen. Es hat sehr wenig Filme in den Bereichen "unkown", was gut ist. Gemäss dem vorherigen Plot wird die Grafik auch getrübt, dadurch, dass 
gewisse Filme über mehrere Genres verfügen. Es könnte sein, dass es viele Filme im Datensatz gibt, die nicht primär nur "Drama" Filme sind.



7.User-Genre-Profil Matrix mit Nutzerprofilen im Genre-Vektorraum erzeugen.
```{r}
NORMALIZED_BY_VIEWS <- TRUE

# Convert both into matrices
user_movie_mat <- as(MovieLense_binary, "matrix")


movie_genre_mat <- movie_genre %>%
  dplyr::select(-title) %>%
  as.matrix()

# Create user genre profile
if (NORMALIZED_BY_VIEWS){
  user_genre_mat <- ((user_movie_mat / as.vector(rowSums(user_movie_mat)))  %*% movie_genre_mat)
} else {
  user_genre_mat <- user_movie_mat %*% movie_genre_mat
}


# Test
check_both_matrices <- test_that(
  "Check matrices types", {
    expect_equal(class(user_movie_mat), class(movie_genre_mat))
  }
)

check_mat_dim <- test_that(
  "Check mat dims", {
    expect_equal(dim(user_movie_mat)[2], dim(movie_genre)[1])
  }
)

check_mat_dim_out <- test_that(
  "Check mat dims output", {
    expect_equal(dim(user_genre_mat), c(dim(user_movie_mat)[1], dim(movie_genre_mat)[2]))
  }
)
```
Achtung! Die Werte können grössere Werte als 1 pro User annehmen trotz Normalisierung der Gesamtviews per User, da gewisse Filme über mehrere
Genres verfügen.




8.Dimension der User-Genre-Profil Matrix prüfen und ausgeben.
9.Anzahl unterschiedlicher Nutzerprofile bestimmen, wenn Stärke der GenreKombination (a) vollständig bzw. (b) nur binär berücksichtigt wird.





## Ähnlichkeit von Nutzern und Filmen

1.Cosinus-Ähnlichkeit zwischen User-Genre- und Movie-Genre-Matrix berechnen.
2.Dimension der Matrix der Cosinus-Ähnlichkeiten von Nutzern und Filmen prüfen uns ausgeben.
3.5-Zahlen Statistik für Matrix der Cosinus-Ähnlichkeiten prüfen uns ausgeben.
4.Cosinus-Ähnlichkeiten von Nutzern und Filmen mit Dichteplot visualisieren.
5.Cosinus-Ähnlichkeiten von Nutzern und Filmen mit Dichteplot für Nutzer “241”, “414”, “477”, “526”, “640” und “710” visualisieren.




## Empfehlbare Filme

1.Bewertete Filme maskieren, d.h. “Negativabzug” der User-Items Matrix erzeugen, um anschliessend Empfehlungen herzuleiten.
2.Zeilensumme des “Negativabzuges” der User-Items Matrix für die User “5”, “25”, “50” und “150” ausgeben.
3.5-Zahlen Statistik der Zeilensumme des “Negativabzuges” der User-Items Matrix bestimmen.




## Top-N Empfehlungen

1.Matrix für Bewertung aller Filme durch element-weise Multiplikation der Matrix der Cosinus-Ähnlichkeiten von Nutzern und Filmen und “Negativabzug” der User-Items Matrix erzeugen.
2.Dimension der Matrix für die Bewertung aller Filme prüfen.
3.Top-20 Listen pro Nutzer extrahieren.
4.Länge der Top-20 Listen pro Nutzer prüfen.
5.Verteilung der minimalen Ähnlichkeit für Top-N Listen für N = 10, 20, 50 und 100 für alle Nutzer visuell vergleichen.
6.Top-20 Empfehlungen für Nutzer “5”, “25”, “50” und “150” visuell evaluieren.
7.Für Nutzer “133” und “555” Profil mit Top-N Empfehlungen für N = 20, 30, 40, 50 analysieren, visualisieren und diskutieren.




